P8105 Data Science I Homework 6
================
Olivia Wang (hw2852)
2022-12-03

In preparation for the problems below, we will load the following
libraries:

``` r
library(tidyverse)
```

    ## ── Attaching packages ─────────────────────────────────────── tidyverse 1.3.2 ──
    ## ✔ ggplot2 3.3.6      ✔ purrr   0.3.4 
    ## ✔ tibble  3.1.8      ✔ dplyr   1.0.10
    ## ✔ tidyr   1.2.0      ✔ stringr 1.4.1 
    ## ✔ readr   2.1.2      ✔ forcats 0.5.2 
    ## ── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──
    ## ✖ dplyr::filter() masks stats::filter()
    ## ✖ dplyr::lag()    masks stats::lag()

``` r
library(readxl)
library(dplyr)
```

# Problem 1

# Problem 2

## 2.1 Homicide Data Import and Cleaning

Let us begin by importing the CSV file containing *Washington Post’s*
homicide data downloaded from GitHub, and applying the `clean_names`
function. Next, we can create a new `city_state` variable
(e.g. “Baltimore, MD”) by joining the existing city and state variables
using the `paste` command, and a new binary `homicide_solved` variable
indicating whether a homicide is solved. The `victim_age` variable
previously read as a character variable is transformed into a numeric
variable. Finally, we filtered the data to exclude information from
Dallas, TX, Phoenix, AZ, Kansas City, MD, and Tulsa, AL, and to only
include victims whose reported race was White or Black.

``` r
homicide_data = 
  read_csv("./homicide-data.csv") %>% 
  janitor::clean_names() %>% 
  mutate(city_state = as.character(paste(city, state, sep = ", ")), 
         homicide_solved = ifelse(disposition == "Closed by arrest", 1, 0), 
         victim_age = as.numeric(victim_age)) %>% 
  filter(!(city_state %in% c("Dallas, TX", "Phoeniz, AZ", "Kansas City, MO", "Tulsa, AL")), 
         victim_race %in% c("White", "Black"))
```

    ## Rows: 52179 Columns: 12
    ## ── Column specification ────────────────────────────────────────────────────────
    ## Delimiter: ","
    ## chr (9): uid, victim_last, victim_first, victim_race, victim_age, victim_sex...
    ## dbl (3): reported_date, lat, lon
    ## 
    ## ℹ Use `spec()` to retrieve the full column specification for this data.
    ## ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.

    ## Warning in mask$eval_all_mutate(quo): NAs introduced by coercion

## 2.2 Homicide Data Analysis: Odds Ratios & 95% CIs

#### *Solved Homicides Comparing Male & Female Victims in Baltimore, MD*

Below we use the `glm` function to estimate the odds ratio of solved
homicides comparing male to female victims, specifically in Baltimore,
MD, adjusting for age and race. The arguments for the `glm` function
indicate that the `homicide_solved` variable is the outcome of interest,
and `victim_age`, `victim_sex` and `victim_race` are the predictors.

The output generated from the `glm` function is then saved as an R
object. The `broom::tidy()` function was applied to tidy the output, and
the log odds ratios, odds ratios, and p-value corresponding to each term
in the regression model were pulled and tabulated. In the final step,
the `confint` function was applied to the output generated from the
`glm` function to generate the 95% confidence intervals surrounding the
odds ratios.

``` r
homicide_data_df = homicide_data %>% 
  filter(city_state == "Baltimore, MD")

glm_homicide_baltimore = 
  homicide_data_df %>% 
  glm(homicide_solved ~ victim_age + victim_sex + victim_race, data = ., family = binomial())

glm_homicide_baltimore %>%
  broom::tidy() %>%
  mutate(odds_ratio = exp(estimate), 
         lower_CI = exp(estimate - 1.96*std.error), 
         upper_CI = exp(estimate + 1.96*std.error)) %>%
  select(term, odds_ratio, lower_CI, upper_CI) %>% 
  filter(term == "victim_sexMale") %>% 
  knitr::kable(col.names = c('Term', 'Odds Ratio', 'Lower 95% CI Limit', 'Upper 95% CI Limit'), digits = 3)
```

| Term           | Odds Ratio | Lower 95% CI Limit | Upper 95% CI Limit |
|:---------------|-----------:|-------------------:|-------------------:|
| victim_sexMale |      0.426 |              0.325 |              0.558 |

In Baltimore, MD, the odds ratio of solving homicides comparing male
victims to female victims, adjusting for age and race, was 0.456. We are
95% confident that the true odds ratio of solving homicides comparing
male and female victims, adjusting for age and race, lies between 0.340
and 0.612.

#### *Solved Homicides Comparing Male & Female Victims in All Cities*

We will now apply the `glm` function to all cities in the data set. This
process involves first creating a new `glm_homicide` function, which
applies the `glm` function to selected inputs. We then use the `select`
function to reorder the columns in the data frame to have `city_state`
appear first, as the function will be mapped to each unique
`city_state`. The city-level homicide data will then be nested using the
`nest` function to generate list columns for city-level homicide counts,
and the `glm_homicide` function will be mapped to each tibble using
`purrr::map`. Finally, we apply the `unnest` function to generate the
city-specific odds ratio and 95% CIs.

``` r
glm_homicide = function(homicide_data) {
  glm(homicide_solved ~ victim_age + victim_sex + victim_race, data = homicide_data, family = binomial()) %>% 
  broom::tidy() %>%
  mutate(odds_ratio = exp(estimate), 
         lower_CI = exp(estimate - 1.96*std.error), 
         upper_CI = exp(estimate + 1.96*std.error)) %>%
  select(term, odds_ratio, lower_CI, upper_CI) %>% 
  filter(term == "victim_sexMale")
}

homicide_data_analysis = homicide_data %>% 
  select(city_state, everything()) %>% 
  nest(data = uid:homicide_solved) %>% 
  mutate(glm_homicide_output = purrr::map(.x = data, ~ glm_homicide(.x))) %>% 
  unnest(cols = glm_homicide_output)

homicide_data_analysis
```

    ## # A tibble: 47 × 6
    ##    city_state      data                  term           odds_r…¹ lower…² upper…³
    ##    <chr>           <list>                <chr>             <dbl>   <dbl>   <dbl>
    ##  1 Albuquerque, NM <tibble [178 × 13]>   victim_sexMale    1.77    0.831   3.76 
    ##  2 Atlanta, GA     <tibble [945 × 13]>   victim_sexMale    1.00    0.684   1.46 
    ##  3 Baltimore, MD   <tibble [2,753 × 13]> victim_sexMale    0.426   0.325   0.558
    ##  4 Baton Rouge, LA <tibble [410 × 13]>   victim_sexMale    0.381   0.209   0.695
    ##  5 Birmingham, AL  <tibble [771 × 13]>   victim_sexMale    0.870   0.574   1.32 
    ##  6 Boston, MA      <tibble [492 × 13]>   victim_sexMale    0.674   0.356   1.28 
    ##  7 Buffalo, NY     <tibble [479 × 13]>   victim_sexMale    0.521   0.290   0.935
    ##  8 Charlotte, NC   <tibble [584 × 13]>   victim_sexMale    0.884   0.557   1.40 
    ##  9 Chicago, IL     <tibble [4,507 × 13]> victim_sexMale    0.410   0.336   0.501
    ## 10 Cincinnati, OH  <tibble [679 × 13]>   victim_sexMale    0.400   0.236   0.677
    ## # … with 37 more rows, and abbreviated variable names ¹​odds_ratio, ²​lower_CI,
    ## #   ³​upper_CI

#### *Plotting City-Specific Solved Homicides Comparing Male & Female Victims*
